<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Configuración - App Suscripciones</title>
  <meta name="description" content="Configuración de la aplicación">
  <meta name="theme-color" content="#1B1930">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  
  <!-- Scripts de Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script src="firebase-config.js"></script>
  <script src="firebase-service.js"></script>
  
  <style>
    body, html {
      overflow-x: hidden !important;
      overscroll-behavior-x: none;
      max-width: 100vw;
      box-sizing: border-box;
    }
    /* Ocultar scrollbars en móvil */
    body::-webkit-scrollbar, html::-webkit-scrollbar {
      display: none !important;
    }
    body {
      -ms-overflow-style: none;
      scrollbar-width: none !important;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }
    html {
      height: -webkit-fill-available;
    }
    html, body {
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch !important;
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Verificar si estamos en un protocolo soportado
        if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
          console.log('⚠️ Abriendo desde sistema de archivos - Service Worker no disponible');
          console.log('Para usar notificaciones, abre la app desde un servidor web (http/https)');
        } else {
          navigator.serviceWorker.register('/PWA-Suscriptions-2/sw.js')
            .then(registration => {
              console.log('ServiceWorker registrado:', registration);
            })
            .catch(error => {
              console.log('Error al registrar ServiceWorker:', error);
            });
        }
      });
    }

    // Función para mostrar notificación en la página
    function showNotification(title, message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      notification.innerHTML = `
        <div class="font-semibold">${title}</div>
        <div class="text-sm">${message}</div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Función para solicitar permisos de notificación
    async function requestNotificationPermission() {
      if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          // Guardar el estado inmediatamente
          localStorage.setItem('notificationPermission', 'granted');
          document.getElementById('notificationStatus').textContent = 'Permitidas';
          document.getElementById('notificationStatus').className = 'text-green-400';
          showNotification('Permisos concedidos', 'Las notificaciones están ahora activas');
          
          // Programar notificaciones después de obtener permisos
          await scheduleNotifications();
        } else if (permission === 'denied') {
          localStorage.setItem('notificationPermission', 'denied');
          document.getElementById('notificationStatus').textContent = 'Denegadas';
          document.getElementById('notificationStatus').className = 'text-red-400';
          showNotification('Permisos denegados', 'Las notificaciones no están disponibles');
        } else {
          localStorage.setItem('notificationPermission', 'default');
          document.getElementById('notificationStatus').textContent = 'No solicitadas';
          document.getElementById('notificationStatus').className = 'text-yellow-400';
        }
      }
    }

    // Función para enviar notificación de prueba
    async function sendTestNotification() {
      if (!('serviceWorker' in navigator)) {
        showNotification('No disponible', 'Service Worker no está disponible');
        return;
      }
      try {
        const registration = await navigator.serviceWorker.ready;
        if (registration.active) {
          registration.active.postMessage({
            type: 'TEST_NOTIFICATION',
            data: {
              title: 'Notificación de prueba',
              body: 'Esto es una notificación de prueba desde Ajustes'
            }
          });
          showNotification('Enviada', 'Notificación de prueba enviada');
        } else {
          showNotification('No disponible', 'Service Worker no está activo');
        }
      } catch (error) {
        console.error('Error al enviar notificación de prueba:', error);
        showNotification('Error', 'No se pudo enviar la notificación de prueba');
      }
    }

    // Función para programar notificaciones
    async function scheduleNotifications() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.ready;
          if (registration.active) {
            const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
            registration.active.postMessage({
              type: 'SCHEDULE_NOTIFICATIONS',
              subscriptions
            });
            console.log('Mensaje enviado al Service Worker para programar notificaciones');
          } else {
            console.log('Service Worker no está activo');
          }
        } catch (error) {
          console.error('Error al programar notificaciones:', error);
        }
      }
    }

    // Función para generar opciones de años
    function generateYearOptions() {
      const yearSelector = document.getElementById('yearSelector');
      if (!yearSelector) return;
      
      const currentYear = new Date().getFullYear();
      const selectedYear = localStorage.getItem('selectedYear') || currentYear;
      
      // Generar años desde 2020 hasta 10 años en el futuro
      const startYear = 2024;
      const endYear = currentYear + 10;
      
      yearSelector.innerHTML = '';
      
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year == selectedYear) {
          option.selected = true;
        }
        yearSelector.appendChild(option);
      }
    }

    // Función para guardar el año seleccionado
    function saveYear() {
      const yearSelector = document.getElementById('yearSelector');
      if (!yearSelector) return;
      
      const selectedYear = yearSelector.value;
      localStorage.setItem('selectedYear', selectedYear);
      
      showNotification('Año guardado', `El año ${selectedYear} ha sido guardado. El calendario se actualizará.`);
      
      console.log('Año guardado:', selectedYear);
    }

    // Función para obtener el año actual
    function getCurrentYear() {
      return localStorage.getItem('selectedYear') || new Date().getFullYear();
    }

    // Función para verificar el estado de las notificaciones
    function checkNotificationStatus() {
      if ('Notification' in window) {
        const permission = Notification.permission;
        const statusElement = document.getElementById('notificationStatus');
        
        if (statusElement) {
          switch(permission) {
            case 'granted':
              statusElement.textContent = 'Permitidas';
              statusElement.className = 'text-green-400';
              // Guardar el estado en localStorage
              localStorage.setItem('notificationPermission', 'granted');
              break;
            case 'denied':
              statusElement.textContent = 'Denegadas';
              statusElement.className = 'text-red-400';
              localStorage.setItem('notificationPermission', 'denied');
              break;
            case 'default':
              statusElement.textContent = 'No solicitadas';
              statusElement.className = 'text-yellow-400';
              localStorage.setItem('notificationPermission', 'default');
              break;
          }
        }
      }
    }

    // Función para cargar el estado guardado de las notificaciones
    function loadNotificationStatus() {
      const savedStatus = localStorage.getItem('notificationPermission');
      const statusElement = document.getElementById('notificationStatus');
      
      if (statusElement && savedStatus) {
        switch(savedStatus) {
          case 'granted':
            statusElement.textContent = 'Permitidas';
            statusElement.className = 'text-green-400';
            break;
          case 'denied':
            statusElement.textContent = 'Denegadas';
            statusElement.className = 'text-red-400';
            break;
          case 'default':
            statusElement.textContent = 'No solicitadas';
            statusElement.className = 'text-yellow-400';
            break;
        }
      } else {
        // Si no hay estado guardado, verificar el estado actual
        checkNotificationStatus();
      }
    }

    // Función para sincronizar el estado real con el guardado
    function syncNotificationStatus() {
      const statusElement = document.getElementById('notificationStatus');
      const contextWarning = document.getElementById('contextWarning');
      
      if (!statusElement) {
        console.log('❌ Elemento notificationStatus no encontrado');
        return;
      }
      
      // Verificar contexto primero
      if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
        statusElement.textContent = 'Contexto no válido';
        statusElement.className = 'text-red-400';
        if (contextWarning) {
          contextWarning.classList.remove('hidden');
        }
        console.log('⚠️ Contexto no válido para notificaciones');
        return;
      } else {
        if (contextWarning) {
          contextWarning.classList.add('hidden');
        }
      }
      
      if ('Notification' in window) {
        const currentPermission = Notification.permission;
        const savedPermission = localStorage.getItem('notificationPermission');
        
        console.log('Estado actual de notificaciones:', currentPermission);
        console.log('Estado guardado:', savedPermission);
        console.log('Elemento encontrado:', statusElement);
        
        // Si el estado guardado es diferente al actual, puede ser que:
        // 1. El usuario cambió los permisos manualmente en el navegador
        // 2. Los permisos se perdieron por alguna razón
        // 3. Estamos en un contexto diferente (sistema de archivos vs servidor)
        
        if (savedPermission && savedPermission !== currentPermission) {
          console.log('⚠️ Estado inconsistente detectado');
          console.log('Estado guardado:', savedPermission, 'vs Estado actual:', currentPermission);
          
          // Si teníamos permisos pero ahora no, puede ser por el contexto
          if (savedPermission === 'granted' && currentPermission === 'default') {
            console.log('Los permisos se perdieron - posiblemente por cambio de contexto');
          }
        }
        
        // Actualizar el estado guardado con el actual
        localStorage.setItem('notificationPermission', currentPermission);
        
        // Actualizar la interfaz
        switch(currentPermission) {
          case 'granted':
            statusElement.textContent = 'Permitidas';
            statusElement.className = 'text-green-400';
            break;
          case 'denied':
            statusElement.textContent = 'Denegadas';
            statusElement.className = 'text-red-400';
            break;
          case 'default':
            statusElement.textContent = 'No solicitadas';
            statusElement.className = 'text-yellow-400';
            break;
        }
        
        console.log('Estado actualizado en la interfaz:', currentPermission);
      } else {
        console.log('Notifications API no disponible');
        statusElement.textContent = 'No disponible';
        statusElement.className = 'text-red-400';
      }
    }

    // Función para limpiar datos
    function clearAllData() {
      if (confirm('¿Estás seguro de que quieres eliminar todos los datos? Esta acción no se puede deshacer.')) {
        localStorage.clear();
        showNotification('Datos eliminados', 'Todos los datos han sido eliminados');
      }
    }

    // Función para limpiar solo la información de pagos
    function clearPaymentData() {
      if (confirm('¿Estás seguro de que quieres limpiar toda la información de pagos de todas las personas? Esto eliminará:\n\n- Todos los registros de pagos (meses, períodos)\n- Comprobantes\n- Estados de pago\n\nLas plataformas y precios se mantendrán intactos.')) {
        const personas = JSON.parse(localStorage.getItem('personas') || '[]');
        
        personas.forEach(persona => {
          // Limpiar comprobantes
          persona.comprobantes = [];
          persona.descripcionComprobantes = '';
          
          // Limpiar información de pagos de cada plataforma
          if (persona.plataformas && Array.isArray(persona.plataformas)) {
            persona.plataformas.forEach(plataforma => {
              // Vaciar el array de pagos
              plataforma.pagos = [];
            });
          }
        });
        
        // Guardar las personas actualizadas
        localStorage.setItem('personas', JSON.stringify(personas));
        
        showNotification('Pagos limpiados', 'Se ha limpiado toda la información de pagos. Las plataformas y precios se mantienen intactos.');
      }
    }

    // Función para actualizar la versión
    function updateVersion() {
      const versionElement = document.getElementById('versionNumber');
      const currentVersion = versionElement.textContent.trim();
      
      // Parsear la versión (formato: X.Y.Z)
      const versionParts = currentVersion.split('.');
      if (versionParts.length === 3) {
        const major = parseInt(versionParts[0]) || 1;
        const minor = parseInt(versionParts[1]) || 0;
        const patch = parseInt(versionParts[2]) || 0;
        
        // Incrementar el patch (último número)
        const newPatch = patch + 1;
        const newVersion = `${major}.${minor}.${newPatch}`;
        
        // Actualizar en el DOM
        versionElement.textContent = newVersion;
        
        // Guardar en localStorage para persistencia
        localStorage.setItem('appVersion', newVersion);
        
        showNotification('Versión actualizada', `Versión actualizada a ${newVersion}`);
        
        console.log(`Versión actualizada de ${currentVersion} a ${newVersion}`);
      } else {
        showNotification('Error', 'Formato de versión no válido');
      }
    }

    // Función para comparar versiones (retorna 1 si v1 > v2, -1 si v1 < v2, 0 si iguales)
    function compareVersions(v1, v2) {
      const parts1 = v1.split('.').map(Number);
      const parts2 = v2.split('.').map(Number);
      
      for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
        const part1 = parts1[i] || 0;
        const part2 = parts2[i] || 0;
        
        if (part1 > part2) return 1;
        if (part1 < part2) return -1;
      }
      
      return 0;
    }

    // Función para incrementar versión manualmente (solo cuando el usuario lo solicite)
    function incrementarVersion() {
      const versionElement = document.getElementById('versionNumber');
      const currentVersion = versionElement.textContent.trim();
      
      // Parsear la versión (formato: X.Y.Z)
      const versionParts = currentVersion.split('.');
      if (versionParts.length === 3) {
        const major = parseInt(versionParts[0]) || 1;
        const minor = parseInt(versionParts[1]) || 0;
        const patch = parseInt(versionParts[2]) || 0;
        
        // Incrementar el patch (último número)
        const newPatch = patch + 1;
        const newVersion = `${major}.${minor}.${newPatch}`;
        
        // Actualizar en el DOM
        versionElement.textContent = newVersion;
        
        // Guardar en localStorage para persistencia
        localStorage.setItem('appVersion', newVersion);
        
        console.log(`Versión actualizada de ${currentVersion} a ${newVersion}`);
      }
    }

    // Inicializar cuando el DOM esté cargado
    // ========== FUNCIONES DE FIREBASE ==========

    async function handleAuth() {
      if (firebaseService.getCurrentUser()) {
        // Ya está autenticado, redirigir a login para cerrar sesión
        window.location.href = 'login.html';
      } else {
        // No está autenticado, ir a login
        window.location.href = 'login.html';
      }
    }

    async function migrateToFirebase() {
      const btn = document.getElementById('btn-migrate');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Migrando...';

      try {
        await firebaseService.migrateToFirebase();
        showNotification('✅ Datos migrados correctamente a la nube', 'success');
        updateFirebaseUI();
      } catch (error) {
        console.error('Error al migrar:', error);
        let errorMessage = 'Error al migrar datos';
        if (error.message.includes('autenticado')) {
          errorMessage = 'Debes iniciar sesión primero';
        } else if (error.message.includes('configurado')) {
          errorMessage = 'Firebase no está configurado. Revisa firebase-config.js';
        }
        showNotification(errorMessage, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function syncToFirebase() {
      const btn = document.getElementById('btn-sync');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Sincronizando...';

      try {
        await firebaseService.syncToFirebase();
        showNotification('✅ Datos sincronizados correctamente', 'success');
      } catch (error) {
        console.error('Error al sincronizar:', error);
        showNotification('Error al sincronizar datos', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function loadFromFirebase() {
      const btn = document.getElementById('btn-load');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Cargando...';

      try {
        const loaded = await firebaseService.loadFromFirebase();
        if (loaded) {
          showNotification('✅ Datos cargados desde la nube', 'success');
          // Recargar la página para reflejar los cambios
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          showNotification('No hay datos en la nube para cargar', 'info');
        }
      } catch (error) {
        console.error('Error al cargar:', error);
        showNotification('Error al cargar datos', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function signOut() {
      if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        try {
          await firebaseService.signOut();
          localStorage.setItem('dataSource', 'localStorage');
          showNotification('Sesión cerrada', 'success');
          updateFirebaseUI();
        } catch (error) {
          console.error('Error al cerrar sesión:', error);
          showNotification('Error al cerrar sesión', 'error');
        }
      }
    }

    function updateFirebaseUI() {
      const isOnline = isFirebaseAvailable();
      const user = firebaseService.getCurrentUser();
      const dataSource = localStorage.getItem('dataSource') || 'localStorage';

      const syncStatus = document.getElementById('sync-status');
      const syncStatusText = document.getElementById('sync-status-text');
      const authStatusText = document.getElementById('auth-status-text');
      const btnAuth = document.getElementById('btn-auth');
      const migrateSection = document.getElementById('migrate-section');
      const syncSection = document.getElementById('sync-section');

      if (!isOnline) {
        syncStatus.textContent = 'No disponible';
        syncStatus.className = 'text-red-400';
        syncStatusText.textContent = 'Firebase no está configurado';
        authStatusText.textContent = 'Firebase no configurado';
        btnAuth.disabled = true;
        migrateSection.classList.add('hidden');
        syncSection.classList.add('hidden');
        return;
      }

      if (user) {
        syncStatus.textContent = 'Conectado';
        syncStatus.className = 'text-green-400';
        syncStatusText.textContent = 'Sincronización activa';
        authStatusText.textContent = `Autenticado como: ${user.email}`;
        btnAuth.textContent = 'Cambiar cuenta';
        
        if (dataSource === 'firebase') {
          migrateSection.classList.add('hidden');
          syncSection.classList.remove('hidden');
        } else {
          migrateSection.classList.remove('hidden');
          syncSection.classList.add('hidden');
        }
      } else {
        syncStatus.textContent = 'Desconectado';
        syncStatus.className = 'text-yellow-400';
        syncStatusText.textContent = 'No autenticado';
        authStatusText.textContent = 'No autenticado';
        btnAuth.textContent = 'Iniciar Sesión';
        migrateSection.classList.add('hidden');
        syncSection.classList.add('hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM cargado, verificando estado de notificaciones...');
      
      // Verificar estado inmediatamente
      syncNotificationStatus();
      updateFirebaseUI();

      // Escuchar cambios de autenticación
      if (isFirebaseAvailable()) {
        firebaseService.onAuthStateChanged(() => {
          updateFirebaseUI();
        });
      }
      
      // Sincronizar estado cuando la página vuelve a estar visible
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log('Página visible, sincronizando estado...');
          syncNotificationStatus();
        }
      });
      
      // Generar opciones de años
      generateYearOptions();
      
      // Actualizar contadores
      const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      
      document.getElementById('totalSubscriptions').textContent = subscriptions.length;
      // Contar solo personas activas
      const personasActivas = personas.filter(p => !p.desuscrita).length;
      document.getElementById('totalPersonas').textContent = personasActivas;
      
      // La versión siempre se toma del HTML como fuente de verdad
      // No se incrementa automáticamente al limpiar caché
      const versionElement = document.getElementById('versionNumber');
      const versionHTML = versionElement.textContent.trim();
      
      // Obtener versión guardada
      const savedVersion = localStorage.getItem('appVersion');
      
      if (!savedVersion) {
        // Primera vez: guardar la versión del HTML
        localStorage.setItem('appVersion', versionHTML);
      } else {
        // Comparar versiones
        const comparacion = compareVersions(versionHTML, savedVersion);
        
        if (comparacion > 0) {
          // La versión del HTML es mayor (nueva versión detectada)
          versionElement.textContent = versionHTML;
          localStorage.setItem('appVersion', versionHTML);
          console.log(`Nueva versión detectada: ${savedVersion} → ${versionHTML}`);
        } else if (comparacion < 0) {
          // La versión guardada es mayor (actualización manual previa)
          versionElement.textContent = savedVersion;
        } else {
          // Son iguales, usar la del HTML
          versionElement.textContent = versionHTML;
        }
      }
    });

    function showClearOptions() {
      const choice = prompt('¿Qué deseas borrar?\n1 = Solo caché\n2 = Solo datos\n3 = Caché y datos\n(Cancelar para no hacer nada)');
      if (!choice) return;
      if (choice === '1') {
        clearCacheAndUpdate(false);
      } else if (choice === '2') {
        clearCacheAndUpdate(true, true);
      } else if (choice === '3') {
        clearCacheAndUpdate(true);
      } else {
        alert('Opción no válida.');
      }
    }

    async function clearCacheAndUpdate(clearData = false, onlyData = false) {
      try {
        console.log('Iniciando limpieza de caché...', { clearData, onlyData });
        
        if (clearData) {
          console.log('Limpiando localStorage...');
          localStorage.clear();
        }
        
        if (!onlyData) {
          // Limpiar caché
          if ('caches' in window) {
            try {
              console.log('Obteniendo nombres de caché...');
              const cacheNames = await caches.keys();
              console.log('Cachés encontrados:', cacheNames);
              await Promise.all(cacheNames.map(name => caches.delete(name)));
              console.log('Caché limpiado correctamente');
            } catch (error) {
              console.error('Error al limpiar caché:', error);
            }
          }
          
          // Desregistrar Service Workers
          if ('serviceWorker' in navigator) {
            try {
              console.log('Desregistrando Service Workers...');
              const registrations = await navigator.serviceWorker.getRegistrations();
              console.log('Service Workers encontrados:', registrations.length);
              for (let reg of registrations) {
                await reg.unregister();
              }
              console.log('Service Workers desregistrados correctamente');
            } catch (error) {
              console.error('Error al desregistrar Service Workers:', error);
            }
          }
        }
        
        console.log('Limpieza completada, recargando página...');
        // Recargar la página después de un pequeño delay para asegurar que todo se procese
        setTimeout(() => {
          window.location.reload(true);
        }, 100);
      } catch (error) {
        console.error('Error en clearCacheAndUpdate:', error);
        alert('Error al limpiar caché: ' + error.message + '\nPor favor, intenta recargar la página manualmente.');
      }
    }

    // Bloquear pinch zoom
    document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
    document.addEventListener('gesturechange', function (e) { e.preventDefault(); });
    document.addEventListener('gestureend', function (e) { e.preventDefault(); });
    // Bloquear doble tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>
</head>
<body class="bg-[#0D0A1A] text-white min-h-screen flex flex-col justify-between">
  <div class="container mx-auto px-4 pt-4 pb-20">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-extrabold leading-tight">Configuración</h1>
      <button onclick="window.location.href='index.html'" class="text-gray-400 hover:text-white">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
    </div>

    <!-- Sección de Notificaciones -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Notificaciones</h2>
      
      <!-- Advertencia de contexto -->
      <div id="contextWarning" class="hidden bg-yellow-600/20 border border-yellow-600/30 rounded-lg p-4 mb-4">
        <div class="flex items-start space-x-3">
          <i class="fas fa-exclamation-triangle text-yellow-400 mt-1"></i>
          <div>
            <h3 class="font-semibold text-yellow-400 mb-2">Contexto no válido para notificaciones</h3>
            <p class="text-yellow-300 text-sm mb-3">
              Estás abriendo la aplicación desde el sistema de archivos. Las notificaciones push requieren un servidor web (http/https).
            </p>
            <div class="text-yellow-300 text-sm">
              <p class="font-semibold mb-1">Para usar notificaciones:</p>
              <ul class="list-disc list-inside space-y-1">
                <li>Usa un servidor local como Live Server en VS Code</li>
                <li>O sube la app a un servidor web</li>
                <li>O usa herramientas como Python: <code class="bg-yellow-600/30 px-1 rounded">python -m http.server</code></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Estado de notificaciones</h3>
            <p class="text-gray-400 text-sm">Permisos del navegador</p>
          </div>
          <span id="notificationStatus" class="text-yellow-400">Verificando...</span>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Solicitar permisos</h3>
            <p class="text-gray-400 text-sm">Activar notificaciones push</p>
          </div>
          <button onclick="requestNotificationPermission()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">
            Solicitar
          </button>
        </div>
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Notificación de prueba</h3>
            <p class="text-gray-400 text-sm">Verifica que las notificaciones funcionan</p>
          </div>
          <button onclick="sendTestNotification()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm">
            Enviar
          </button>
        </div>
        <div class="flex justify-between items-center mt-4">
          <button onclick="if(confirm('¿Estás seguro de que quieres eliminar el caché? Esto recargará la aplicación.')) { clearCacheAndUpdate(false); }" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm w-full">Eliminar caché</button>
        </div>
      </div>
    </div>

    <!-- Sección de Mensajería -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Mensajería</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Generar mensajes</h3>
            <p class="text-gray-400 text-sm">Crear mensajes personalizados para usuarios</p>
          </div>
          <button onclick="window.location.href='mensajeria.html'" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Sección de Cotizar -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Cotizar</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Calcular precios y ganancias</h3>
            <p class="text-gray-400 text-sm">Cotizar suscripciones compartidas</p>
          </div>
          <button onclick="window.location.href='cotizar.html'" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Sección de Desuscripción de Personas -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Desuscripción de Personas</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Gestionar desuscripciones</h3>
            <p class="text-gray-400 text-sm">Marcar personas como desuscritas</p>
          </div>
          <button onclick="window.location.href='desuscripcion.html'" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-sm w-24">
            Abrir
          </button>
        </div>
      </div>
    </div>

    <!-- Sección de Sincronización en la Nube -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Sincronización en la Nube</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Estado de sincronización</h3>
            <p class="text-gray-400 text-sm" id="sync-status-text">Verificando...</p>
          </div>
          <span id="sync-status" class="text-yellow-400">-</span>
        </div>

        <div id="auth-section" class="space-y-3">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="font-semibold">Autenticación</h3>
              <p class="text-gray-400 text-sm" id="auth-status-text">No autenticado</p>
            </div>
            <button onclick="handleAuth()" id="btn-auth" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">
              Iniciar Sesión
            </button>
          </div>
        </div>

        <div id="migrate-section" class="hidden">
          <div class="bg-yellow-600/20 border border-yellow-600/30 rounded-lg p-4 mb-4">
            <div class="flex items-start space-x-3">
              <i class="fas fa-info-circle text-yellow-400 mt-1"></i>
              <div>
                <h3 class="font-semibold text-yellow-400 mb-2">Migrar datos a la nube</h3>
                <p class="text-yellow-300 text-sm">
                  Esto copiará todos tus datos actuales (suscripciones, personas, mensajes) a Firebase. 
                  Tus datos locales se mantendrán como respaldo.
                </p>
              </div>
            </div>
          </div>
          <button onclick="migrateToFirebase()" id="btn-migrate" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm">
            Migrar datos a la nube
          </button>
        </div>

        <div id="sync-section" class="hidden">
          <button onclick="syncToFirebase()" id="btn-sync" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm">
            Sincronizar ahora
          </button>
          <button onclick="loadFromFirebase()" id="btn-load" class="w-full bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm mt-2">
            Cargar desde la nube
          </button>
          <button onclick="signOut()" id="btn-signout" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm mt-2">
            Cerrar Sesión
          </button>
        </div>
      </div>
    </div>

    <!-- Sección de Datos -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Datos</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Archivar datos de usuarios</h3>
            <p class="text-gray-400 text-sm">Ver resumen de usuarios y estadísticas</p>
          </div>
          <button onclick="window.location.href='archivo-datos.html'" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm w-24">
            Ver archivo
          </button>
        </div>
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Limpiar datos</h3>
            <p class="text-gray-400 text-sm">Eliminar todos los datos</p>
          </div>
          <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm w-24">
            Limpiar
          </button>
        </div>
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Limpiar pagos</h3>
            <p class="text-gray-400 text-sm">Limpiar información de pagos de todas las personas</p>
          </div>
          <button onclick="clearPaymentData()" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-sm w-24">
            Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Sección de Información -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Información</h2>
      
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Año actual</h3>
            <p class="text-gray-400 text-sm">Año para el calendario</p>
          </div>
          <div class="flex items-center space-x-2">
            <select id="yearSelector" class="bg-[#3f3f46] rounded-md px-3 py-1 text-white text-sm border-none focus:outline-none">
              <!-- Las opciones se generarán dinámicamente -->
            </select>
            <button onclick="saveYear()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm">
              Guardar
            </button>
          </div>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Versión</h3>
            <p class="text-gray-400 text-sm">App Suscripciones</p>
          </div>
          <span id="versionNumber" class="text-gray-400 font-semibold">1.0.45</span>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Suscripciones</h3>
            <p class="text-gray-400 text-sm">Total de suscripciones</p>
          </div>
          <span id="totalSubscriptions" class="text-gray-400">0</span>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-semibold">Personas</h3>
            <p class="text-gray-400 text-sm">Total de personas</p>
          </div>
          <span id="totalPersonas" class="text-gray-400">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#1B1930]/80 backdrop-blur-md flex justify-between items-center px-16 py-4 border-t border-white/10 text-white/50 text-xs">
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='index.html'">
      <i class="fas fa-moon text-lg"></i>
      <span class="select-none">Subscriptions</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='calendar.html'">
      <i class="fas fa-th-large text-xl"></i>
      <span class="select-none">Calendar</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='personas.html'">
      <i class="fas fa-users text-lg"></i>
      <span class="select-none">Personas</span>
    </button>
    <button class="flex flex-col items-center space-y-1 text-white" onclick="window.location.href='settings.html'">
      <i class="fas fa-cog text-lg"></i>
      <span class="select-none">Settings</span>
    </button>
  </nav>
</body>
</html> 