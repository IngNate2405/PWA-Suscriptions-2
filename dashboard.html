<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Dashboard - App Suscripciones</title>
  <meta name="description" content="Dashboard y métricas de suscripciones">
  <meta name="theme-color" content="#1B1930">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="version.js"></script>
  <style>
    html, body {
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch !important;
    }
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    body, html {
      box-sizing: border-box;
    }
    /* Contenedor principal que usa todo el ancho */
    .dashboard-container {
      width: 100%;
      padding: 2rem;
    }
    @media (max-width: 768px) {
      .dashboard-container {
        padding: 1rem;
      }
    }
    /* Limitar tamaño máximo de los cuadros de métricas */
    .metric-card {
      width: 100%;
      max-width: 250px;
      height: 120px;
    }
  </style>
</head>
<body class="bg-[#0D0A1A] text-white min-h-screen flex flex-col justify-between">
  <div class="dashboard-container">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-extrabold leading-tight">Dashboard</h1>
      <button onclick="window.location.href='settings.html'" class="text-gray-400 hover:text-white">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
    </div>

    <!-- Sección de Métricas Generales -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Métricas Generales</h2>
      
      <div class="grid grid-cols-4 gap-4">
        <!-- Métrica 1 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Suscripciones Activas</span>
            <i class="fas fa-tv text-purple-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-subscriptions">0</p>
        </div>

        <!-- Métrica 2 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Suscripciones Compartidas</span>
            <i class="fas fa-share-alt text-blue-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-shared">0</p>
        </div>

        <!-- Métrica 3 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Personas Activas</span>
            <i class="fas fa-users text-green-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-personas">0</p>
        </div>

        <!-- Métrica 4 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Cobro Mensual (USD)</span>
            <i class="fas fa-dollar-sign text-yellow-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-cobro-usd">$0</p>
        </div>

        <!-- Métrica 5 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Cobro Mensual (GTQ)</span>
            <i class="fas fa-dollar-sign text-orange-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-cobro-gtq">Q0</p>
        </div>

        <!-- Métrica 6 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Cobro Real por Persona</span>
            <i class="fas fa-user-dollar text-cyan-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-cobro-persona">Q0</p>
        </div>

        <!-- Métrica 7 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Ganancia Mensual</span>
            <i class="fas fa-chart-line text-green-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-ganancia-mensual">Q0</p>
        </div>

        <!-- Métrica 8 -->
        <div class="bg-[#2a1f3d] rounded-lg p-3 metric-card flex flex-col justify-between">
          <div class="flex items-center justify-between mb-1">
            <span class="text-gray-400 text-xs">Ganancia Semestral</span>
            <i class="fas fa-chart-bar text-purple-400 text-sm"></i>
          </div>
          <p class="text-xl font-bold" id="metric-ganancia-semestral">Q0</p>
        </div>
      </div>
    </div>

    <!-- Sección de Métricas Detalladas -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Análisis Detallado</h2>
      
      <div class="space-y-4">
        <!-- Gasto por Plataforma -->
        <div class="bg-[#2a1f3d] rounded-lg p-4">
          <h3 class="font-semibold mb-3">Gasto por Plataforma (Mensual)</h3>
          <div id="gasto-plataformas" class="space-y-2">
            <!-- Se llenará dinámicamente -->
          </div>
        </div>

        <!-- Ingreso por Plataforma -->
        <div class="bg-[#2a1f3d] rounded-lg p-4">
          <h3 class="font-semibold mb-3">Ingreso por Plataforma (Mensual)</h3>
          <div id="ingreso-plataformas" class="space-y-2">
            <!-- Se llenará dinámicamente -->
          </div>
        </div>

        <!-- Beneficio Neto -->
        <div class="bg-[#2a1f3d] rounded-lg p-4">
          <h3 class="font-semibold mb-3">Beneficio Neto por Plataforma</h3>
          <div id="beneficio-plataformas" class="space-y-2">
            <!-- Se llenará dinámicamente -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation - Oculto en dashboard de escritorio -->
  <style>
    @media (min-width: 769px) {
      nav {
        display: none;
      }
      .dashboard-container {
        padding-bottom: 2rem;
      }
    }
  </style>
  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#1B1930]/80 backdrop-blur-md flex justify-between items-center px-16 py-4 border-t border-white/10 text-white/50 text-xs">
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='index.html'">
      <i class="fas fa-moon text-lg"></i>
      <span class="select-none">Subscriptions</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='calendar.html'">
      <i class="fas fa-th-large text-lg"></i>
      <span class="select-none">Calendar</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='personas.html'">
      <i class="fas fa-users text-lg"></i>
      <span class="select-none">Personas</span>
    </button>
    <button class="flex flex-col items-center space-y-1 text-white" onclick="window.location.href='settings.html'">
      <i class="fas fa-cog text-lg"></i>
      <span class="select-none">Settings</span>
    </button>
  </nav>
  <div class="fixed bottom-0 left-0 right-0 text-center text-[#6b6b7b] text-[10px] pb-1 pointer-events-none z-40">
    <span id="app-version"></span>
  </div>

  <script>
    // Función para cargar métricas
    function cargarMetricas() {
      const subscriptions = JSON.parse(localStorage.getItem('subscriptions') || '[]');
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      const conversionRate = 8; // Tasa de conversión USD a GTQ

      // Filtrar personas desuscritas
      const personasActivas = personas.filter(p => !p.desuscrita);

      // 1. Total de Suscripciones Activas
      const suscripcionesActivas = subscriptions.filter(s => s.status !== 'paused').length;

      // 2. Total de Suscripciones Compartidas (las que tienen personas asignadas)
      const suscripcionesCompartidas = subscriptions.filter(s => {
        if (s.status === 'paused') return false;
        return personasActivas.some(p => 
          p.plataformas && p.plataformas.some(pl => pl.id === s.id || pl.nombre === s.name)
        );
      }).length;

      // 3. Total de Personas Activas
      const totalPersonasActivas = personasActivas.length;

      // 4. Total de Cobro Mensual en Dólares (precio original USD convertido a mensual)
      let cobroMensualUSD = 0;
      // 5. Total de Cobro Mensual Convertido a Quetzales
      let cobroMensualGTQ = 0;
      // 6. Total de Cobro real a cada persona (suma de lo que realmente cobras)
      let cobroRealPersonas = 0;
      // Gasto mensual (debit_price_gtq convertido a mensual)
      let gastoMensual = 0;

      subscriptions.forEach(sub => {
        if (sub.status === 'paused') return;

        // Obtener precio original en USD
        const originalPriceUSD = parseFloat(sub.original_price_usd) || 0;
        // Obtener precio debitado en GTQ
        const debitPriceGTQ = parseFloat(sub.debit_price_gtq) || 0;
        const billing = sub.billing || sub.billingCycle || 'mensual';

        // Convertir a mensual según el ciclo de facturación
        let precioMensualUSD = originalPriceUSD;
        let precioMensualGTQ = debitPriceGTQ;
        
        switch (billing) {
          case 'trimestral':
            precioMensualUSD = originalPriceUSD / 3;
            precioMensualGTQ = debitPriceGTQ / 3;
            break;
          case 'semestral':
            precioMensualUSD = originalPriceUSD / 6;
            precioMensualGTQ = debitPriceGTQ / 6;
            break;
          case 'anual':
            precioMensualUSD = originalPriceUSD / 12;
            precioMensualGTQ = debitPriceGTQ / 12;
            break;
        }

        cobroMensualUSD += precioMensualUSD;
        cobroMensualGTQ += (precioMensualUSD * conversionRate);
        gastoMensual += precioMensualGTQ;

        // Calcular cobro real por persona (sumar lo que cada persona paga)
        personasActivas.forEach(persona => {
          persona.plataformas?.forEach(plataforma => {
            if (plataforma.id === sub.id || plataforma.nombre === sub.name) {
              const precioPersona = parseFloat(plataforma.precio) || 0;
              const tipoCobroPersona = plataforma.tipoCobro || 'mensual';
              
              // Convertir el precio de la persona a mensual
              let precioMensualPersona = precioPersona;
              switch (tipoCobroPersona) {
                case 'trimestral':
                  precioMensualPersona = precioPersona / 3;
                  break;
                case 'semestral':
                  precioMensualPersona = precioPersona / 6;
                  break;
                case 'anual':
                  precioMensualPersona = precioPersona / 12;
                  break;
              }
              
              cobroRealPersonas += precioMensualPersona;
            }
          });
        });
      });

      // 7. Ganancia Mensual = Cobro real - Gasto mensual
      const gananciaMensual = cobroRealPersonas - gastoMensual;
      
      // 8. Ganancia Semestral = Ganancia mensual * 6
      const gananciaSemestral = gananciaMensual * 6;

      // Actualizar métricas principales
      document.getElementById('metric-subscriptions').textContent = suscripcionesActivas;
      document.getElementById('metric-shared').textContent = suscripcionesCompartidas;
      document.getElementById('metric-personas').textContent = totalPersonasActivas;
      document.getElementById('metric-cobro-usd').textContent = `$${cobroMensualUSD.toFixed(2)}`;
      document.getElementById('metric-cobro-gtq').textContent = `Q${cobroMensualGTQ.toFixed(2)}`;
      document.getElementById('metric-cobro-persona').textContent = `Q${cobroRealPersonas.toFixed(2)}`;
      document.getElementById('metric-ganancia-mensual').textContent = `Q${gananciaMensual.toFixed(2)}`;
      document.getElementById('metric-ganancia-semestral').textContent = `Q${gananciaSemestral.toFixed(2)}`;

      // Mantener las secciones de análisis detallado (gasto e ingreso por plataforma)
      const gastoPorPlataforma = {};
      const ingresoPorPlataforma = {};

      subscriptions.forEach(sub => {
        if (sub.status === 'paused') return;

        const debitPriceGTQ = parseFloat(sub.debit_price_gtq) || 0;
        const billing = sub.billing || sub.billingCycle || 'mensual';
        let precioMensualGTQ = debitPriceGTQ;

        switch (billing) {
          case 'trimestral':
            precioMensualGTQ = debitPriceGTQ / 3;
            break;
          case 'semestral':
            precioMensualGTQ = debitPriceGTQ / 6;
            break;
          case 'anual':
            precioMensualGTQ = debitPriceGTQ / 12;
            break;
        }

        if (!gastoPorPlataforma[sub.name]) {
          gastoPorPlataforma[sub.name] = 0;
        }
        gastoPorPlataforma[sub.name] += precioMensualGTQ;

        // Calcular ingreso por plataforma (cobro real de personas en esa plataforma)
        let ingresoPlataforma = 0;
        personasActivas.forEach(persona => {
          persona.plataformas?.forEach(plataforma => {
            if (plataforma.id === sub.id || plataforma.nombre === sub.name) {
              const precioPersona = parseFloat(plataforma.precio) || 0;
              const tipoCobroPersona = plataforma.tipoCobro || 'mensual';
              
              let precioMensualPersona = precioPersona;
              switch (tipoCobroPersona) {
                case 'trimestral':
                  precioMensualPersona = precioPersona / 3;
                  break;
                case 'semestral':
                  precioMensualPersona = precioPersona / 6;
                  break;
                case 'anual':
                  precioMensualPersona = precioPersona / 12;
                  break;
              }
              
              ingresoPlataforma += precioMensualPersona;
            }
          });
        });

        if (ingresoPlataforma > 0) {
          if (!ingresoPorPlataforma[sub.name]) {
            ingresoPorPlataforma[sub.name] = 0;
          }
          ingresoPorPlataforma[sub.name] += ingresoPlataforma;
        }
      });

      // Mostrar gasto por plataforma
      const gastoPlataformasDiv = document.getElementById('gasto-plataformas');
      gastoPlataformasDiv.innerHTML = '';
      Object.entries(gastoPorPlataforma)
        .sort((a, b) => b[1] - a[1])
        .forEach(([nombre, gasto]) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          div.innerHTML = `
            <span class="text-gray-300">${nombre}</span>
            <span class="font-semibold text-red-400">Q${gasto.toFixed(2)}</span>
          `;
          gastoPlataformasDiv.appendChild(div);
        });

      // Mostrar ingreso por plataforma
      const ingresoPlataformasDiv = document.getElementById('ingreso-plataformas');
      ingresoPlataformasDiv.innerHTML = '';
      Object.entries(ingresoPorPlataforma)
        .sort((a, b) => b[1] - a[1])
        .forEach(([nombre, ingreso]) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          div.innerHTML = `
            <span class="text-gray-300">${nombre}</span>
            <span class="font-semibold text-green-400">Q${ingreso.toFixed(2)}</span>
          `;
          ingresoPlataformasDiv.appendChild(div);
        });

      // Mostrar beneficio neto por plataforma
      const beneficioPlataformasDiv = document.getElementById('beneficio-plataformas');
      beneficioPlataformasDiv.innerHTML = '';
      const beneficios = {};
      Object.keys(gastoPorPlataforma).forEach(nombre => {
        beneficios[nombre] = (ingresoPorPlataforma[nombre] || 0) - gastoPorPlataforma[nombre];
      });
      Object.entries(beneficios)
        .sort((a, b) => b[1] - a[1])
        .forEach(([nombre, beneficio]) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          const colorClass = beneficio >= 0 ? 'text-green-400' : 'text-red-400';
          div.innerHTML = `
            <span class="text-gray-300">${nombre}</span>
            <span class="font-semibold ${colorClass}">Q${beneficio.toFixed(2)}</span>
          `;
          beneficioPlataformasDiv.appendChild(div);
        });
    }

    // Cargar versión
    document.addEventListener('DOMContentLoaded', () => {
      cargarMetricas();
      if (typeof cargarVersion === 'function') {
        cargarVersion();
      }
    });

    // Bloquear pinch zoom
    document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
    document.addEventListener('gesturechange', function (e) { e.preventDefault(); });
    document.addEventListener('gestureend', function (e) { e.preventDefault(); });
    // Bloquear doble tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>

