<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Desuscripción de Personas - App Suscripciones</title>
  <meta name="description" content="Gestionar desuscripciones de personas">
  <meta name="theme-color" content="#1B1930">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body, html {
      overflow-x: hidden !important;
      overscroll-behavior-x: none;
      max-width: 100vw;
      box-sizing: border-box;
    }
    body::-webkit-scrollbar, html::-webkit-scrollbar {
      display: none !important;
    }
    body {
      -ms-overflow-style: none;
      scrollbar-width: none !important;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }
    html {
      height: -webkit-fill-available;
    }
    html, body {
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch !important;
    }
  </style>
</head>
<body class="bg-[#0D0A1A] text-white min-h-screen flex flex-col justify-between">
  <div class="container mx-auto px-4 pt-4 pb-20">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-extrabold leading-tight">Desuscripción de Personas</h1>
      <button onclick="window.location.href='settings.html'" class="text-gray-400 hover:text-white">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
    </div>

    <!-- Sección de Desuscripción -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Gestionar Desuscripciones</h2>
      <p class="text-gray-400 text-sm mb-6">Selecciona una persona y activa el switch para desuscribirla. Se eliminarán todas sus plataformas y dejará de aparecer en los listados.</p>
      
      <!-- Selector de persona -->
      <div class="mb-6">
        <label class="block text-gray-400 text-sm mb-2">Seleccionar persona</label>
        <select id="persona-select" onchange="cargarPersonaSeleccionada()" class="w-full bg-[#2a2736] text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#3f2a6f]">
          <option value="">Selecciona una persona</option>
        </select>
      </div>

      <!-- Switch de desuscripción -->
      <div id="switch-container" class="hidden mb-6">
        <div class="bg-[#2a2736] rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold text-white" id="persona-nombre"></h3>
              <p class="text-gray-500 text-sm mt-1" id="persona-plataformas"></p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer ml-4">
              <input type="checkbox" 
                     id="desuscribir-switch"
                     onchange="toggleDesuscripcionSeleccionada(this.checked)"
                     class="sr-only peer">
              <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#3f2a6f] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
              <span class="ml-3 text-sm text-gray-400" id="estado-switch">Activa</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Listado de personas desuscritas -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Personas Desuscritas</h2>
      
      <div class="space-y-3" id="desuscritas-container">
        <!-- Las personas desuscritas se cargarán aquí -->
      </div>
    </div>
  </div>

  <script>
    // Función para mostrar notificación
    function showNotification(title, message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      notification.innerHTML = `
        <div class="font-semibold">${title}</div>
        <div class="text-sm">${message}</div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Función para cargar personas activas en el selector
    function cargarSelectorPersonas() {
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      const select = document.getElementById('persona-select');
      
      // Filtrar solo personas activas (no desuscritas)
      const personasActivas = personas.filter(p => !p.desuscrita);
      
      select.innerHTML = '<option value="">Selecciona una persona</option>';
      
      if (personasActivas.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No hay personas activas';
        option.disabled = true;
        select.appendChild(option);
        return;
      }
      
      personasActivas.forEach(persona => {
        const option = document.createElement('option');
        option.value = persona.id;
        option.textContent = persona.nombre;
        select.appendChild(option);
      });
    }

    // Función para cargar persona seleccionada
    function cargarPersonaSeleccionada() {
      const select = document.getElementById('persona-select');
      const personaId = select.value;
      const switchContainer = document.getElementById('switch-container');
      
      if (!personaId) {
        switchContainer.classList.add('hidden');
        return;
      }
      
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      const persona = personas.find(p => p.id === parseInt(personaId));
      
      if (!persona) {
        switchContainer.classList.add('hidden');
        return;
      }
      
      // Mostrar información de la persona
      document.getElementById('persona-nombre').textContent = persona.nombre;
      const plataformasTexto = persona.plataformas && persona.plataformas.length > 0 
        ? persona.plataformas.map(p => p.nombre).join(', ')
        : 'Sin plataformas';
      document.getElementById('persona-plataformas').textContent = plataformasTexto;
      
      // Configurar switch
      const switchInput = document.getElementById('desuscribir-switch');
      const estadoSpan = document.getElementById('estado-switch');
      
      switchInput.checked = persona.desuscrita || false;
      estadoSpan.textContent = persona.desuscrita ? 'Desuscrita' : 'Activa';
      
      switchContainer.classList.remove('hidden');
    }

    // Función para cargar listado de personas desuscritas
    function cargarDesuscritas() {
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      const container = document.getElementById('desuscritas-container');
      
      // Filtrar solo personas desuscritas
      const personasDesuscritas = personas.filter(p => p.desuscrita);
      
      if (personasDesuscritas.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-4">
            No hay personas desuscritas
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      // Ordenar por nombre
      personasDesuscritas.sort((a, b) => a.nombre.localeCompare(b.nombre));
      
      personasDesuscritas.forEach(persona => {
        const personaDiv = document.createElement('div');
        personaDiv.className = 'bg-[#2a2736] rounded-lg p-4 opacity-60';
        
        const plataformasTexto = persona.plataformasAnteriores && persona.plataformasAnteriores.length > 0 
          ? persona.plataformasAnteriores.map(p => p.nombre).join(', ')
          : 'Sin plataformas guardadas';
        
        personaDiv.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h3 class="font-semibold text-gray-400">${persona.nombre}</h3>
              <p class="text-gray-500 text-sm mt-1">${plataformasTexto}</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer ml-4">
              <input type="checkbox" 
                     checked
                     onchange="toggleDesuscripcion(${persona.id}, false)"
                     class="sr-only peer">
              <div class="w-11 h-6 bg-red-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#3f2a6f] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
              <span class="ml-3 text-sm text-gray-400">Desuscrita</span>
            </label>
          </div>
        `;
        container.appendChild(personaDiv);
      });
    }

    // Función para toggle desuscripción desde el switch principal
    function toggleDesuscripcionSeleccionada(desuscrita) {
      const select = document.getElementById('persona-select');
      const personaId = select.value;
      
      if (!personaId) return;
      
      toggleDesuscripcion(parseInt(personaId), desuscrita);
    }

    // Función para toggle desuscripción
    function toggleDesuscripcion(personaId, desuscrita) {
      const personas = JSON.parse(localStorage.getItem('personas') || '[]');
      const personaIndex = personas.findIndex(p => p.id === parseInt(personaId));
      
      if (personaIndex === -1) return;
      
      if (desuscrita) {
        // Guardar las plataformas antes de desuscribir
        if (personas[personaIndex].plataformas && personas[personaIndex].plataformas.length > 0) {
          personas[personaIndex].plataformasAnteriores = JSON.parse(JSON.stringify(personas[personaIndex].plataformas));
        }
        // Marcar como desuscrita y limpiar plataformas
        personas[personaIndex].desuscrita = true;
        personas[personaIndex].plataformas = [];
        showNotification('Persona desuscrita', `${personas[personaIndex].nombre} ha sido desuscrita y removida de todas las plataformas.`);
      } else {
        // Reactivar persona y restaurar plataformas si existen
        personas[personaIndex].desuscrita = false;
        if (personas[personaIndex].plataformasAnteriores && personas[personaIndex].plataformasAnteriores.length > 0) {
          personas[personaIndex].plataformas = JSON.parse(JSON.stringify(personas[personaIndex].plataformasAnteriores));
          // Opcional: eliminar el campo de plataformas anteriores después de restaurar
          delete personas[personaIndex].plataformasAnteriores;
          showNotification('Persona reactivada', `${personas[personaIndex].nombre} ha sido reactivada y sus plataformas han sido restauradas.`);
        } else {
          showNotification('Persona reactivada', `${personas[personaIndex].nombre} ha sido reactivada.`);
        }
      }
      
      localStorage.setItem('personas', JSON.stringify(personas));
      
      // Recargar todo
      cargarSelectorPersonas();
      cargarDesuscritas();
      
      // Si la persona seleccionada fue desuscrita, limpiar selector
      const select = document.getElementById('persona-select');
      if (desuscrita && select.value == personaId) {
        select.value = '';
        document.getElementById('switch-container').classList.add('hidden');
      } else if (!desuscrita) {
        // Si se reactivó, actualizar la vista si está seleccionada
        if (select.value == personaId) {
          cargarPersonaSeleccionada();
        }
      }
    }

    // Función para cargar versión
    function cargarVersion() {
      const versionElement = document.getElementById('app-version');
      if (!versionElement) return;
      
      const versionHTML = '1.0.45'; // Versión base del código
      const savedVersion = localStorage.getItem('appVersion');
      
      // Si hay una versión guardada y es mayor, usarla
      if (savedVersion && savedVersion > versionHTML) {
        versionElement.textContent = `v${savedVersion}`;
      } else {
        versionElement.textContent = `v${versionHTML}`;
        localStorage.setItem('appVersion', versionHTML);
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      cargarVersion();
      cargarSelectorPersonas();
      cargarDesuscritas();
    });

    // Bloquear pinch zoom
    document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
    document.addEventListener('gesturechange', function (e) { e.preventDefault(); });
    document.addEventListener('gestureend', function (e) { e.preventDefault(); });
    // Bloquear doble tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#1B1930]/80 backdrop-blur-md flex justify-between items-center px-16 py-4 border-t border-white/10 text-white/50 text-xs">
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='index.html'">
      <i class="fas fa-moon text-lg"></i>
      <span class="select-none">Subscriptions</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='calendar.html'">
      <i class="fas fa-th-large text-xl"></i>
      <span class="select-none">Calendar</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='personas.html'">
      <i class="fas fa-users text-lg"></i>
      <span class="select-none">Personas</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='settings.html'">
      <i class="fas fa-cog text-lg"></i>
      <span class="select-none">Settings</span>
    </button>
  </nav>
  <div class="fixed bottom-0 left-0 right-0 text-center text-[#6b6b7b] text-[10px] pb-1 pointer-events-none z-40">
    <span id="app-version">v1.0.45</span>
  </div>
</body>
</html>

