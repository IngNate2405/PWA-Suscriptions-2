<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Mensajer铆a - App Suscripciones</title>
  <meta name="description" content="Generar mensajes para usuarios">
  <meta name="theme-color" content="#1B1930">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body, html {
      overflow-x: hidden !important;
      overscroll-behavior-x: none;
      max-width: 100vw;
      box-sizing: border-box;
    }
    body::-webkit-scrollbar, html::-webkit-scrollbar {
      display: none !important;
    }
    body {
      -ms-overflow-style: none;
      scrollbar-width: none !important;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }
    html {
      height: -webkit-fill-available;
    }
    html, body {
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch !important;
    }
  </style>
</head>
<body class="bg-[#0D0A1A] text-white min-h-screen flex flex-col justify-between">
  <div class="container mx-auto px-4 pt-4 pb-20">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-extrabold leading-tight">Mensajer铆a</h1>
      <button onclick="window.location.href='index.html'" class="text-gray-400 hover:text-white">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
    </div>

    <!-- Secci贸n de Generar Mensaje -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Generar Mensaje</h2>
      
      <div class="space-y-4">
        <!-- Seleccionar Plataforma -->
        <div>
          <label class="block text-sm font-semibold mb-2">Filtrar por Plataforma</label>
          <select id="plataforma-select" onchange="cargarPersonas()" class="w-full bg-[#2a2736] text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#3f2a6f]">
            <option value="todas">Todas las plataformas</option>
          </select>
        </div>

        <!-- Seleccionar Persona -->
        <div>
          <label class="block text-sm font-semibold mb-2">Seleccionar Persona</label>
          <select id="persona-select" class="w-full bg-[#2a2736] text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#3f2a6f]">
            <option value="">Selecciona una persona</option>
          </select>
        </div>

        <!-- Suscripciones de la Persona -->
        <div id="suscripciones-container" class="hidden">
          <label class="block text-sm font-semibold mb-2">Suscripciones Activas</label>
          <div id="suscripciones-list" class="space-y-2">
            <!-- Se cargar谩 din谩micamente -->
          </div>
        </div>

        <!-- Precios Personalizados -->
        <div id="precios-container" class="hidden">
          <label class="block text-sm font-semibold mb-2">Precios de Suscripciones</label>
          <div id="precios-list" class="space-y-2">
            <!-- Se cargar谩 din谩micamente -->
          </div>
        </div>

        <!-- Plantilla de Mensaje -->
        <div>
          <label class="block text-sm font-semibold mb-2">Mensaje Generado</label>
          <textarea id="mensaje-generado" readonly class="w-full bg-[#2a2736] text-white rounded-lg px-4 py-3 h-32 focus:outline-none focus:ring-2 focus:ring-[#3f2a6f]" placeholder="El mensaje aparecer谩 aqu铆..."></textarea>
        </div>

        <!-- Botones de Acci贸n -->
        <div class="flex space-x-3">
          <button onclick="copiarMensaje()" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold">
            <i class="fas fa-copy mr-2"></i>Copiar Mensaje
          </button>
          <button onclick="marcarEnviado()" class="flex-1 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-semibold">
            <i class="fas fa-check mr-2"></i>Marcar como Enviado
          </button>
        </div>
      </div>
    </div>

    <!-- Secci贸n de Listado de Personas -->
    <div class="bg-[#1B1930] rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Listado de Personas</h2>
      
      <div id="personas-listado" class="space-y-3">
        <!-- Se cargar谩 din谩micamente -->
      </div>
    </div>
  </div>

  <script>
    let personas = [];
    let personaSeleccionada = null;
    let suscripcionesSeleccionadas = [];
    let preciosPersonalizados = {};

    // Funci贸n para mostrar notificaci贸n
    function showNotification(title, message, type = 'success') {
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50`;
      notification.innerHTML = `
        <div class="font-semibold">${title}</div>
        <div class="text-sm">${message}</div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Funci贸n para cargar plataformas en el selector
    function cargarPlataformas() {
      personas = JSON.parse(localStorage.getItem('personas') || '[]');
      
      // Filtrar solo personas activas (no desuscritas)
      const personasActivas = personas.filter(p => !p.desuscrita);
      
      // Obtener todas las plataformas 煤nicas de las personas activas
      const plataformasSet = new Set();
      personasActivas.forEach(persona => {
        if (persona.plataformas && persona.plataformas.length > 0) {
          persona.plataformas.forEach(plataforma => {
            plataformasSet.add(plataforma.nombre);
          });
        }
      });
      
      // Ordenar plataformas alfab茅ticamente
      const plataformas = Array.from(plataformasSet).sort();
      
      // Llenar selector de plataformas
      const selectPlataforma = document.getElementById('plataforma-select');
      if (selectPlataforma) {
        selectPlataforma.innerHTML = '<option value="todas">Todas las plataformas</option>';
        plataformas.forEach(plataforma => {
          const option = document.createElement('option');
          option.value = plataforma;
          option.textContent = plataforma;
          selectPlataforma.appendChild(option);
        });
      }
    }

    // Funci贸n para cargar personas
    function cargarPersonas() {
      personas = JSON.parse(localStorage.getItem('personas') || '[]');
      
      // Cargar estado de mensajes enviados
      const mensajesEnviados = JSON.parse(localStorage.getItem('mensajesEnviados') || '{}');
      
      // Obtener plataforma seleccionada
      const selectPlataforma = document.getElementById('plataforma-select');
      const plataformaSeleccionada = selectPlataforma ? selectPlataforma.value : 'todas';
      
      // Filtrar solo personas activas (no desuscritas) y que no tengan mensaje enviado
      let personasActivas = personas.filter(p => !p.desuscrita);
      
      // Filtrar por plataforma si no es "todas"
      if (plataformaSeleccionada !== 'todas') {
        personasActivas = personasActivas.filter(persona => {
          return persona.plataformas && persona.plataformas.some(p => p.nombre === plataformaSeleccionada);
        });
      }
      
      // Filtrar solo las que no tienen mensaje enviado
      const personasSinMensaje = personasActivas.filter(p => !mensajesEnviados[p.id]);
      
      // Llenar select de personas (solo las que no tienen mensaje enviado)
      const select = document.getElementById('persona-select');
      if (select) {
        select.innerHTML = '<option value="">Selecciona una persona</option>';
        
        if (personasSinMensaje.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'Ninguna persona pendiente de mensaje';
          option.disabled = true;
          select.appendChild(option);
        } else {
          personasSinMensaje.forEach(persona => {
            const option = document.createElement('option');
            option.value = persona.id;
            option.textContent = persona.nombre;
            select.appendChild(option);
          });
        }
      }

      // Cargar listado de personas
      const listadoContainer = document.getElementById('personas-listado');
      if (!listadoContainer) {
        console.error('No se encontr贸 el contenedor personas-listado');
        return;
      }
      
      listadoContainer.innerHTML = '';

      if (personasActivas.length === 0) {
        listadoContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No hay personas registradas</p>';
        return;
      }

      personasActivas.forEach(persona => {
        const enviado = mensajesEnviados[persona.id] || false;
        const personaDiv = document.createElement('div');
        personaDiv.className = `bg-[#2a2736] rounded-lg p-4 ${enviado ? 'border-2 border-green-500' : ''}`;
        
        personaDiv.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <input type="checkbox" ${enviado ? 'checked' : ''} 
                     onchange="toggleMensajeEnviado(${persona.id}, this.checked)"
                     class="w-5 h-5 rounded bg-[#3f3f46] border-[#3f3f46] text-[#3f2a6f] focus:ring-[#3f2a6f]">
              <div>
                <h3 class="font-semibold">${persona.nombre}</h3>
                <p class="text-gray-400 text-sm">${persona.plataformas.length} plataforma${persona.plataformas.length !== 1 ? 's' : ''}</p>
              </div>
            </div>
            ${enviado ? '<span class="text-green-400 text-sm"><i class="fas fa-check-circle"></i> Enviado</span>' : ''}
          </div>
        `;
        listadoContainer.appendChild(personaDiv);
      });
    }

    // Funci贸n para toggle mensaje enviado
    function toggleMensajeEnviado(personaId, enviado) {
      const mensajesEnviados = JSON.parse(localStorage.getItem('mensajesEnviados') || '{}');
      mensajesEnviados[personaId] = enviado;
      localStorage.setItem('mensajesEnviados', JSON.stringify(mensajesEnviados));
      cargarPersonas();
      
      if (enviado) {
        showNotification('Marcado', 'Persona marcada como mensaje enviado');
      }
    }

    // Funci贸n para cuando se selecciona una persona
    function onPersonaSeleccionada() {
      const select = document.getElementById('persona-select');
      const personaId = parseInt(select.value);
      
      if (!personaId) {
        document.getElementById('suscripciones-container').classList.add('hidden');
        document.getElementById('precios-container').classList.add('hidden');
        document.getElementById('mensaje-generado').value = '';
        personaSeleccionada = null;
        suscripcionesSeleccionadas = [];
        return;
      }

      personaSeleccionada = personas.find(p => p.id === personaId);
      if (!personaSeleccionada) return;

      // Mostrar suscripciones
      const suscripcionesContainer = document.getElementById('suscripciones-container');
      const suscripcionesList = document.getElementById('suscripciones-list');
      suscripcionesContainer.classList.remove('hidden');
      suscripcionesList.innerHTML = '';

      suscripcionesSeleccionadas = [];
      preciosPersonalizados = {};

      // Obtener suscripciones compartidas para buscar apodos
      const suscripciones = JSON.parse(localStorage.getItem('subscriptions') || '[]');
      
      personaSeleccionada.plataformas.forEach((plataforma, index) => {
        // Buscar el apodo de la suscripci贸n compartida
        const suscripcionCompartida = suscripciones.find(sub => sub.name === plataforma.nombre && sub.list === 'compartido');
        const nombreParaMensaje = suscripcionCompartida && suscripcionCompartida.apodo ? suscripcionCompartida.apodo : plataforma.nombre;
        
        const suscripcionDiv = document.createElement('div');
        suscripcionDiv.className = 'flex items-center space-x-3 bg-[#2a2736] rounded-lg p-3';
        
        suscripcionDiv.innerHTML = `
          <input type="checkbox" id="susc-${index}" checked 
                 onchange="toggleSuscripcion(${index}, this.checked)"
                 class="w-5 h-5 rounded bg-[#3f3f46] border-[#3f3f46] text-[#3f2a6f] focus:ring-[#3f2a6f]">
          <label for="susc-${index}" class="flex-1 cursor-pointer">
            <span class="font-semibold">${plataforma.nombre}</span>
            <span class="text-gray-400 text-sm ml-2">Q${plataforma.precio.toFixed(2)}</span>
          </label>
        `;
        suscripcionesList.appendChild(suscripcionDiv);
        
        suscripcionesSeleccionadas.push({
          nombre: plataforma.nombre,
          nombreParaMensaje: nombreParaMensaje, // Usar apodo si existe
          precio: plataforma.precio,
          index: index
        });
      });

      // Mostrar precios personalizados
      mostrarPreciosPersonalizados();
      generarMensaje();
    }

    // Funci贸n para toggle suscripci贸n
    function toggleSuscripcion(index, seleccionada) {
      if (seleccionada) {
        const plataforma = personaSeleccionada.plataformas[index];
        // Buscar el apodo de la suscripci贸n compartida
        const suscripciones = JSON.parse(localStorage.getItem('subscriptions') || '[]');
        const suscripcionCompartida = suscripciones.find(sub => sub.name === plataforma.nombre && sub.list === 'compartido');
        const nombreParaMensaje = suscripcionCompartida && suscripcionCompartida.apodo ? suscripcionCompartida.apodo : plataforma.nombre;
        
        suscripcionesSeleccionadas.push({
          nombre: plataforma.nombre,
          nombreParaMensaje: nombreParaMensaje, // Usar apodo si existe
          precio: plataforma.precio,
          index: index
        });
      } else {
        suscripcionesSeleccionadas = suscripcionesSeleccionadas.filter(s => s.index !== index);
      }
      mostrarPreciosPersonalizados();
      generarMensaje();
    }

    // Funci贸n para mostrar precios personalizados
    function mostrarPreciosPersonalizados() {
      const preciosContainer = document.getElementById('precios-container');
      const preciosList = document.getElementById('precios-list');
      
      if (suscripcionesSeleccionadas.length === 0) {
        preciosContainer.classList.add('hidden');
        return;
      }

      preciosContainer.classList.remove('hidden');
      preciosList.innerHTML = '';

      suscripcionesSeleccionadas.forEach(suscripcion => {
        const precioDiv = document.createElement('div');
        precioDiv.className = 'flex items-center space-x-3 bg-[#2a2736] rounded-lg p-3';
        
        precioDiv.innerHTML = `
          <label class="flex-1">
            <span class="text-sm text-gray-400">${suscripcion.nombre}:</span>
            <input type="number" 
                   value="${suscripcion.precio.toFixed(2)}" 
                   step="0.01"
                   min="0"
                   onchange="actualizarPrecio(${suscripcion.index}, parseFloat(this.value))"
                   class="w-full bg-[#3f3f46] text-white rounded px-3 py-2 mt-1 focus:outline-none focus:ring-2 focus:ring-[#3f2a6f]">
          </label>
        `;
        preciosList.appendChild(precioDiv);
      });
    }

    // Funci贸n para actualizar precio
    function actualizarPrecio(index, nuevoPrecio) {
      const suscripcion = suscripcionesSeleccionadas.find(s => s.index === index);
      if (suscripcion) {
        suscripcion.precio = nuevoPrecio || 0;
        preciosPersonalizados[index] = nuevoPrecio;
        generarMensaje();
      }
    }

    // Funci贸n para generar mensaje
    function generarMensaje() {
      if (!personaSeleccionada || suscripcionesSeleccionadas.length === 0) {
        document.getElementById('mensaje-generado').value = '';
        return;
      }

      const nombre = personaSeleccionada.nombre;
      const sumaTotal = suscripcionesSeleccionadas.reduce((sum, s) => sum + (s.precio || 0), 0);
      
      // Obtener mes actual y calcular per铆odo
      const ahora = new Date();
      const mesActual = ahora.getMonth(); // 0-11
      const anioActual = ahora.getFullYear();
      
      // Calcular per铆odo actual (Enero a Junio) y futuro (Julio a Diciembre)
      let periodoActual = '';
      let periodoFuturo = '';
      let fechaLimite = '';
      
      if (mesActual >= 0 && mesActual <= 5) {
        // Estamos en Enero-Junio
        periodoActual = 'Enero a Junio';
        periodoFuturo = 'Julio a Diciembre';
        fechaLimite = '1 de Julio';
      } else {
        // Estamos en Julio-Diciembre
        periodoActual = 'Julio a Diciembre';
        periodoFuturo = `Enero a Junio de ${anioActual + 1}`;
        fechaLimite = `1 de Enero de ${anioActual + 1}`;
      }
      
      // Construir lista de suscripciones con precios (usando apodo si existe)
      let listaSuscripciones = '';
      suscripcionesSeleccionadas.forEach((suscripcion, index) => {
        const precio = suscripcion.precio || 0;
        const nombreAMostrar = suscripcion.nombreParaMensaje || suscripcion.nombre;
        listaSuscripciones += `*Q${precio.toFixed(0)}* de ${nombreAMostrar}`;
        if (index < suscripcionesSeleccionadas.length - 1) {
          listaSuscripciones += ' . ';
        }
      });

      // Obtener nombres para el mensaje (usando apodo si existe)
      const nombresParaMensaje = suscripcionesSeleccionadas.map(s => s.nombreParaMensaje || s.nombre);

      // Generar mensaje con el formato solicitado
      let mensaje = `隆Hola ${nombre} ! 驴C贸mo est谩s?\n`;
      mensaje += `Espero que bien \n`;
      mensaje += `Quer铆a comentarte que el plazo de ${periodoActual} de tu plan de streaming de ( *${nombresParaMensaje.join('* y *')}* ) est谩 por terminar este mes. Y quisiera saber si te gustar铆a seguir con nosotros otros seis meses, que seria de ${periodoFuturo}.\n`;
      mensaje += `El pago semestral ser铆a de  ${listaSuscripciones} . *Total ${sumaTotal.toFixed(0)}*\n`;
      mensaje += `Si es de tu inter茅s continuar, solo necesito de tu confirmaci贸n y si fuera posible que en estos d铆as o antes del *${fechaLimite}* puedas hacer el deposito o pago en efectivo te lo agradecer铆a bastante, para que yo pueda coordinar los espacios en la plataforma.\n`;
      mensaje += `Me cuentas :D`;

      document.getElementById('mensaje-generado').value = mensaje;
    }

    // Funci贸n para copiar mensaje
    function copiarMensaje() {
      const textarea = document.getElementById('mensaje-generado');
      if (!textarea) {
        showNotification('Error', 'No se encontr贸 el campo de mensaje', 'error');
        return;
      }
      
      const mensaje = textarea.value;
      if (!mensaje || mensaje.trim() === '') {
        showNotification('Error', 'No hay mensaje para copiar', 'error');
        return;
      }

      // Intentar usar la API moderna del portapapeles
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(mensaje).then(() => {
          showNotification('Copiado', 'Mensaje copiado al portapapeles');
        }).catch((err) => {
          console.error('Error al copiar con clipboard API:', err);
          // Fallback para navegadores antiguos
          copiarMensajeFallback(textarea, mensaje);
        });
      } else {
        // Fallback para navegadores antiguos
        copiarMensajeFallback(textarea, mensaje);
      }
    }

    // Funci贸n fallback para copiar mensaje
    function copiarMensajeFallback(textarea, mensaje) {
      try {
        // Seleccionar el texto del textarea directamente
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, mensaje.length);
        
        // Intentar copiar
        const exito = document.execCommand('copy');
        if (exito) {
          showNotification('Copiado', 'Mensaje copiado al portapapeles');
        } else {
          // Si falla, crear un textarea temporal
          const tempTextarea = document.createElement('textarea');
          tempTextarea.value = mensaje;
          tempTextarea.style.position = 'fixed';
          tempTextarea.style.left = '-9999px';
          tempTextarea.style.top = '0';
          document.body.appendChild(tempTextarea);
          tempTextarea.focus();
          tempTextarea.select();
          
          try {
            document.execCommand('copy');
            showNotification('Copiado', 'Mensaje copiado al portapapeles');
          } catch (err) {
            console.error('Error al copiar:', err);
            showNotification('Error', 'No se pudo copiar el mensaje. Por favor, selecci贸nalo manualmente.', 'error');
          } finally {
            document.body.removeChild(tempTextarea);
          }
        }
      } catch (err) {
        console.error('Error en fallback de copiar:', err);
        showNotification('Error', 'No se pudo copiar el mensaje. Por favor, selecci贸nalo manualmente.', 'error');
      }
    }

    // Funci贸n para marcar como enviado
    function marcarEnviado() {
      if (!personaSeleccionada) {
        showNotification('Error', 'Selecciona una persona primero', 'error');
        return;
      }

      const mensajesEnviados = JSON.parse(localStorage.getItem('mensajesEnviados') || '{}');
      mensajesEnviados[personaSeleccionada.id] = true;
      localStorage.setItem('mensajesEnviados', JSON.stringify(mensajesEnviados));
      
      showNotification('Marcado', 'Persona marcada como mensaje enviado');
      cargarPersonas();
    }

    // Funci贸n para cargar versi贸n
    function cargarVersion() {
      const versionElement = document.getElementById('app-version');
      if (!versionElement) return;
      
      const versionHTML = '1.0.45'; // Versi贸n base del c贸digo
      const savedVersion = localStorage.getItem('appVersion');
      
      // Si hay una versi贸n guardada y es mayor, usarla
      if (savedVersion && savedVersion > versionHTML) {
        versionElement.textContent = `v${savedVersion}`;
      } else {
        versionElement.textContent = `v${versionHTML}`;
        localStorage.setItem('appVersion', versionHTML);
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      cargarVersion();
      cargarPlataformas();
      cargarPersonas();
      
      document.getElementById('persona-select').addEventListener('change', onPersonaSeleccionada);
    });

    // Bloquear pinch zoom
    document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
    document.addEventListener('gesturechange', function (e) { e.preventDefault(); });
    document.addEventListener('gestureend', function (e) { e.preventDefault(); });
    // Bloquear doble tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#1B1930]/80 backdrop-blur-md flex justify-between items-center px-16 py-4 border-t border-white/10 text-white/50 text-xs">
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='index.html'">
      <i class="fas fa-moon text-lg"></i>
      <span class="select-none">Subscriptions</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='calendar.html'">
      <i class="fas fa-th-large text-xl"></i>
      <span class="select-none">Calendar</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='personas.html'">
      <i class="fas fa-users text-lg"></i>
      <span class="select-none">Personas</span>
    </button>
    <button class="flex flex-col items-center space-y-1" onclick="window.location.href='settings.html'">
      <i class="fas fa-cog text-lg"></i>
      <span class="select-none">Settings</span>
    </button>
  </nav>
  <div class="fixed bottom-0 left-0 right-0 text-center text-[#6b6b7b] text-[10px] pb-1 pointer-events-none z-40">
    <span id="app-version">v1.0.45</span>
  </div>
</body>
</html>

